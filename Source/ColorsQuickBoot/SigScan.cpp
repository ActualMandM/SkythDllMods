#include "SigScan.h"
#include <Psapi.h>

MODULEINFO moduleInfo;

const MODULEINFO& getModuleInfo()
{
    if (moduleInfo.SizeOfImage)
        return moduleInfo;

    ZeroMemory(&moduleInfo, sizeof(MODULEINFO));
    GetModuleInformation(GetCurrentProcess(), GetModuleHandle(nullptr), &moduleInfo, sizeof(MODULEINFO));

    return moduleInfo;
}

void* sigScan(const char* signature, const char* mask)
{
    const MODULEINFO& moduleInfo = getModuleInfo();
    const size_t length = strlen(mask);

    for (size_t i = 0; i < moduleInfo.SizeOfImage; i++)
    {
        char* memory = (char*)moduleInfo.lpBaseOfDll + i;

        size_t j;
        for (j = 0; j < length; j++)
        {
            if (mask[j] != '?' && signature[j] != memory[j])
                break;
        }

        if (j == length) 
            return memory;
    }

    return nullptr;
}

#define SIG_SCAN(x, signature, mask) \
    void* _##x; \
    void* x() \
    { \
        if (!_##x) _##x = sigScan(signature, mask); \
        return _##x; \
    }

SIG_SCAN(sigStateStartUp, "\x40\x55\x56\x57\x48\x8B\xEC\x48\x83\xEC\x40\x48\xC7\x45\x00\x00\x00\x00\x00\x48\x89\x5C\x24\x00\x48\x8B\xFA\x48\x8B\xF1\x41\x8B\x00\x83\xF8\xFC\x0F\x84\x00\x00\x00\x00\x83\xF8\xFD\x74\x7E\x83\xF8\x01\x75\x67\x49\x8B\x40\x08\x81\x78\x00\x00\x00\x00\x00\x75\x5A\x48\x8D\x0D\x00\x00\x00\x00\x48\x89\x4D\xE8\x33\xDB\x48\x89\x5D\xF0\x89\x5D\xF8\x0F\x10\x45\xE8\x0F\x11\x46\x58\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4E\x00\xC6\x40\x14\x01\x48\x89\x5D\xE8\xC7\x45\x00\x00\x00\x00\x00\x48\x89\x5D\xF0\x0F\x10\x45\xE8\x0F\x11\x02\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4A\x00\x48\x8B\xC7\x48\x8B\x5C\x24\x00\x48\x83\xC4\x40\x5F\x5E\x5D\xC3\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xE8\x33\xDB\x89\x5D\xF8\xEB\xC9\xC6\x05\x00\x00\x00\x00\x00\xC7\x45\x00\x00\x00\x00\x00\xBA\x00\x00\x00\x00\x8D\x4A\xA1\xE8\x00\x00\x00\x00\x48\x89\x45\x38\x33\xDB\x48\x85\xC0\x74\x0A\x48\x8B\xC8\xE8\x00\x00\x00\x00\xEB\x03\x48\x8B\xC3\x48\x89\x46\x40\x48\x8B\xD0\x48\x8B\x4E\x38\xE8\x00\x00\x00\x00\xEB\x16\x48\x8B\x49\x38\xE8\x00\x00\x00\x00\x33\xDB\x48\x89\x5E\x40\xC6\x05\x00\x00\x00\x00\x00\x48\x89\x5D\xE8\x48\x89\x5D\xF0\x0F\x10\x45\xE8\xC7\x45\x00\x00\x00\x00\x00\x0F\x11\x07\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4F\x00\x48\x8B\xC7\x48\x8B\x5C\x24\x00\x48\x83\xC4\x40\x5F\x5E\x5D\xC3", "xxxxxxxxxxxxxx?????xxxx?xxxxxxxxxxxxxx????xxxxxxxxxxxxxxxx?????xxxxx????xxxxxxxxxxxxxxxxxxxxxxxxx?xxxx?xxxxxxxxxx?????xxxxxxxxxxxxxxx?xxxx?xxxxxxx?xxxxxxxxxxx????xxxxxxxxxxxxx?????xx?????x????xxxx????xxxxxxxxxxxxxxx????xxxxxxxxxxxxxxxxx????xxxxxxx????xxxxxxxx?????xxxxxxxxxxxxxx?????xxxxxxx?xxxx?xxxxxxx?xxxxxxxx");
SIG_SCAN(sigStateTitle, "\x40\x55\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\x48\x8B\xEC\x48\x83\xEC\x60\x48\xC7\x45\x00\x00\x00\x00\x00\x48\x89\x9C\x24\x00\x00\x00\x00\x4C\x8B\xFA\x4C\x8B\xF1\x41\x8B\x00\x83\xF8\xFC\x0F\x84\x00\x00\x00\x00\x83\xF8\xFD\x0F\x84\x00\x00\x00\x00\x83\xF8\x01\x0F\x85\x00\x00\x00\x00\x4D\x8B\x68\x08\x41\x8B\x45\x08\x3D\x00\x00\x00\x00\x0F\x85\x00\x00\x00\x00\x4C\x8B\x61\x40\xC6\x41\x73\x02\x33\xF6\x48\x89\xB1\x00\x00\x00\x00\x41\x8B\x8C\x24\x00\x00\x00\x00\x85\xC9\x74\x60\x83\xE9\x01\x74\x15\x83\xF9\x01\x0F\x85\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\xE9\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\x50\xE8\x00\x00\x00\x00\x48\x8D\x55\x58\x48\x8D\x4D\x50\xE8\x00\x00\x00\x00\x48\x8D\x55\xC8\x48\x8D\x4D\x58\xE8\x00\x00\x00\x00\x48\x8B\xC8\xE8\x00\x00\x00\x00\x41\x89\x86\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\xE9\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\xC8\xE8\x00\x00\x00\x00\x48\x8D\x55\x58\x48\x8D\x4D\xC8\xE8\x00\x00\x00\x00\x48\x8D\x4D\x58\xE8\x00\x00\x00\x00\x8B\xD8\x48\x8D\x4D\x58\xE8\x00\x00\x00\x00\x8B\xF8\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\xC8\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\xD8\xE8\x00\x00\x00\x00\x48\x8B\xC8\x33\xD2\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\xC8\xE8\x00\x00\x00\x00\x48\x8D\x55\xC0\x48\x8D\x4D\xC8\xE8\x00\x00\x00\x00\x48\x8D\x4D\xC0\xE8\x00\x00\x00\x00\x48\x8D\x55\xD8\x48\x8D\x4D\xC0\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x15\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\xC8\xE8\x00\x00\x00\x00\x48\x8D\x55\x50\x48\x8D\x4D\xC8\xE8\x00\x00\x00\x00\x8B\xD6\x41\x38\xB4\x24\x00\x00\x00\x00\x0F\x95\xC2\x48\x8D\x4D\x50\xE8\x00\x00\x00\x00\x8B\xD3\x48\x8D\x4D\x50\xE8\x00\x00\x00\x00\x8B\xD7\x48\x8D\x4D\x50\xE8\x00\x00\x00\x00\x33\xD2\x48\x8D\x4D\x50\xE8\x00\x00\x00\x00\xF7\x05\x00\x00\x00\x00\x00\x00\x00\x00\x74\x1E\x40\x38\x35\x00\x00\x00\x00\x75\x15\x40\x38\x35\x00\x00\x00\x00\x75\x0C\xE8\x00\x00\x00\x00\xC6\x05\x00\x00\x00\x00\x00\x33\xD2\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x41\xC7\x86\x00\x00\x00\x00\x00\x00\x00\x00\x41\x89\xB6\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x40\x38\xB0\x00\x00\x00\x00\x74\x07\xBA\x00\x00\x00\x00\xEB\x10\xE8\x00\x00\x00\x00\x40\x38\xB0\x00\x00\x00\x00\x74\x0A\x33\xD2\x49\x8B\xCE\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x40\x38\xB0\x00\x00\x00\x00\x74\x19\x41\xC7\x46\x00\x00\x00\x00\x00\x41\xC7\x46\x00\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\xEB\x0B\x49\x89\x76\x78\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xE0\x48\x89\x75\xE8\x0F\x10\x45\xE0\x89\x75\xF0\x41\x0F\x11\x46\x00\xF2\x0F\x10\x4D\x00\xF2\x41\x0F\x11\x4E\x00\x41\xC6\x45\x00\x00\xE9\x00\x00\x00\x00\x3D\x00\x00\x00\x00\x75\x50\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xE0\x33\xF6\x48\x89\x75\xE8\x89\x75\xF0\x0F\x10\x45\xE0\x0F\x11\x41\x58\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x49\x00\x41\xC6\x45\x00\x00\x48\x89\x75\xE0\xC7\x45\x00\x00\x00\x00\x00\x48\x89\x75\xE8\x0F\x10\x45\xE0\x0F\x11\x02\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4A\x00\xE9\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xE0\x33\xF6\x89\x75\xF0\xEB\xD4\xC7\x45\x00\x00\x00\x00\x00\xBA\x00\x00\x00\x00\x8D\x4A\x91\xE8\x00\x00\x00\x00\x48\x89\x45\x58\x33\xF6\x48\x85\xC0\x74\x14\x45\x0F\xB6\x86\x00\x00\x00\x00\x33\xD2\x48\x8B\xC8\xE8\x00\x00\x00\x00\xEB\x03\x48\x8B\xC6\x49\x89\x46\x40\x48\x8B\xD0\x49\x8B\x4E\x38\xE8\x00\x00\x00\x00\xEB\x16\xC6\x81\x00\x00\x00\x00\x00\x48\x8B\x49\x38\xE8\x00\x00\x00\x00\x33\xF6\x49\x89\x76\x40\x48\x89\x75\xE0\x48\x89\x75\xE8\x0F\x10\x45\xE0\xC7\x45\x00\x00\x00\x00\x00\x41\x0F\x11\x07\xF2\x0F\x10\x4D\x00\xF2\x41\x0F\x11\x4F\x00\x49\x8B\xC7\x48\x8B\x9C\x24\x00\x00\x00\x00\x48\x83\xC4\x60\x41\x5F\x41\x5E\x41\x5D\x41\x5C\x5F\x5E\x5D\xC3", "xxxxxxxxxxxxxxxxxxxxxx?????xxxx????xxxxxxxxxxxxxx????xxxxx????xxxxx????xxxxxxxxx????xx????xxxxxxxxxxxxx????xxxx????xxxxxxxxxxxxxx????xxx????x????x????xxxxxxxx????xxxxxxxxx????xxxxxxxxx????xxxx????xxx????xxx????x????x????xxxxxxxx????xxxxxxxxx????xxxxx????xxxxxxx????xxx????xxxxxxxx????xxxxxxxx????xxxxxx????x????xxxxxxxx????xxxxxxxxx????xxxxx????xxxxxxxxx????xxxxxx????x????x????xxxxxxxx????xxxxxxxxx????xxxxxx????xxxxxxxx????xxxxxxx????xxxxxxx????xxxxxxx????xx????????xxxxx????xxxxx????xxx????xx?????xxxxx????x????xxx????????xxx????x????xxx????xxx????xxx????xxx????xxxxxxxx????x????xxx????xxxxx?????xxx?????xxx????xxxxxxxxx????xxxxxxxxxxxxxxxxxxx?xxxx?xxxxx?xxx??x????x????xxxxx????xxxxxxxxxxxxxxxxxxxxxxxxx?xxxx?xxx??xxxxxx?????xxxxxxxxxxxxxxx?xxxx?x????xxx????xxxxxxxxxxxxx?????x????xxxx????xxxxxxxxxxxxxxx????xxxxxx????xxxxxxxxxxxxxxxxx????xxxx?????xxxxx????xxxxxxxxxxxxxxxxxxxx?????xxxxxxxx?xxxxx?xxxxxxx????xxxxxxxxxxxxxxxx");;
SIG_SCAN(sigStateWorldMap, "\x4C\x8B\xDC\x57\x48\x81\xEC\x00\x00\x00\x00\x49\xC7\x43\x00\x00\x00\x00\x00\x49\x89\x5B\x08\x49\x89\x73\x10\x48\x8B\xFA\x48\x8B\xF1\x41\x83\x38\xFD\x74\x2E\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x44\x24\x00\x33\xDB\x49\x89\x5B\x80\x89\x5C\x24\x30\x0F\x10\x44\x24\x00\x0F\x11\x02\xF2\x0F\x10\x4C\x24\x00\xF2\x0F\x11\x4A\x00\xE9\x00\x00\x00\x00\x48\x8D\x4C\x24\x00\xE8\x00\x00\x00\x00\x90\x33\xDB\x89\x5C\x24\x40\x8B\x46\x78\x89\x44\x24\x48\x48\x8D\x54\x24\x00\x48\x8B\xCE\xE8\x00\x00\x00\x00\xC7\x84\x24\x00\x00\x00\x00\x00\x00\x00\x00\xBA\x00\x00\x00\x00\x8D\x4A\x69\xE8\x00\x00\x00\x00\x48\x89\x84\x24\x00\x00\x00\x00\x48\x85\xC0\x74\x0F\x48\x8D\x54\x24\x00\x48\x8B\xC8\xE8\x00\x00\x00\x00\xEB\x03\x48\x8B\xC3\x48\x89\x46\x40\x48\x8B\xD0\x48\x8B\x4E\x38\xE8\x00\x00\x00\x00\x90\x48\x8B\x54\x24\x00\x48\xF7\xC2\x00\x00\x00\x00\x75\x33\x0F\xBA\xF2\x1F\x48\xC1\xE2\x03\x48\x8B\x4C\x24\x00\x48\x8B\xC1\x48\x81\xFA\x00\x00\x00\x00\x72\x15\x48\x83\xC2\x27\x48\x8B\x49\xF8\x48\x2B\xC1\x48\x83\xC0\xF8\x48\x83\xF8\x1F\x77\x42\xE8\x00\x00\x00\x00\x48\x89\x5C\x24\x00\x48\x89\x5C\x24\x00\xC7\x44\x24\x00\x00\x00\x00\x00\x0F\x10\x44\x24\x00\x0F\x11\x07\xF2\x0F\x10\x4C\x24\x00\xF2\x0F\x11\x4F\x00\x48\x8B\xC7\x4C\x8D\x9C\x24\x00\x00\x00\x00\x49\x8B\x5B\x10\x49\x8B\x73\x18\x49\x8B\xE3\x5F\xC3\xE8\x00\x00\x00\x00", "xxxxxxx????xxx?????xxxxxxxxxxxxxxxxxxxxxxx????xxxx?xxxxxxxxxxxxxx?xxxxxxxx?xxxx?x????xxxx?x????xxxxxxxxxxxxxxxxxx?xxxx????xxx????????x????xxxx????xxxx????xxxxxxxxx?xxxx????xxxxxxxxxxxxxxxxx????xxxxx?xxx????xxxxxxxxxxxxxx?xxxxxx????xxxxxxxxxxxxxxxxxxxxxxxx????xxxx?xxxx?xxx?????xxxx?xxxxxxxx?xxxx?xxxxxxx????xxxxxxxxxxxxxx????");
SIG_SCAN(sigStateStage, "\x40\x55\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\x48\x8D\x6C\x24\x00\x48\x81\xEC\x00\x00\x00\x00\x48\xC7\x45\x00\x00\x00\x00\x00\x48\x89\x9C\x24\x00\x00\x00\x00\x4C\x8B\xFA\x48\x8B\xD9\x41\x8B\x00\x83\xF8\xFC\x0F\x84\x00\x00\x00\x00\x83\xF8\xFD\x0F\x84\x00\x00\x00\x00\x83\xF8\x01\x0F\x85\x00\x00\x00\x00\x4D\x8B\x68\x08\x41\x8B\x45\x08\x3D\x00\x00\x00\x00\x0F\x85\x00\x00\x00\x00\x48\x8B\x79\x40\xE8\x00\x00\x00\x00\x83\xBF\x00\x00\x00\x00\x00\x74\x68\x83\x7B\x78\x06\x7F\x59\x75\x23\x83\x7B\x7C\x01\x75\x1D\xBA\x00\x00\x00\x00\x44\x8D\x42\xFB\x48\x8B\xCB\xE8\x00\x00\x00\x00\x84\xC0\x75\x08\x48\x8B\xCB\xE8\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xA7\x33\xF6\x48\x89\x75\xAF\x89\x75\xB7\x0F\x10\x45\xA7\x0F\x11\x43\x58\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4B\x00\x41\xC6\x45\x00\x00\x48\x89\x75\xAF\xE9\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\xEB\xCA\x48\x8B\xCB\xE8\x00\x00\x00\x00\x44\x8B\x43\x7C\x8B\x53\x78\x48\x8B\xCB\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x33\xF6\x40\x38\xB0\x00\x00\x00\x00\x0F\x84\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\xC8\x48\x8D\x55\x7F\xE8\x00\x00\x00\x00\x48\x8D\x55\xBF\x48\x8D\x4D\x7F\xE8\x00\x00\x00\x00\x48\x8D\x55\x77\x48\x8D\x4D\xBF\xE8\x00\x00\x00\x00\x8B\xFE\x41\xBE\x00\x00\x00\x00\x66\x0F\x1F\x84\x00\x00\x00\x00\x00\x44\x8B\xC7\x41\x8B\xD6\x48\x8D\x4D\x77\xE8\x00\x00\x00\x00\x84\xC0\x74\x5C\xFF\xC7\x83\xFF\x07\x7C\xE6\x8B\xFE\x0F\x1F\x40\x00\x45\x33\xC9\x44\x8B\xC7\x41\x8B\xD6\x48\x8D\x4D\x77\xE8\x00\x00\x00\x00\xFF\xC7\x83\xFF\x07\x7C\xE7\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xA7\x48\x89\x75\xAF\x89\x75\xB7\x0F\x10\x45\xA7\x0F\x11\x43\x58\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4B\x00\x41\xC6\x45\x00\x00\x48\xC7\x45\x00\x00\x00\x00\x00\xE9\x00\x00\x00\x00\x48\x8B\xCB\xE8\x00\x00\x00\x00\x41\xC6\x45\x00\x00\x48\xC7\x45\x00\x00\x00\x00\x00\xE9\x00\x00\x00\x00\x3D\x00\x00\x00\x00\x0F\x85\x00\x00\x00\x00\x41\xBE\x00\x00\x00\x00\x45\x8B\xC6\x33\xD2\xE8\x00\x00\x00\x00\x84\xC0\x75\x5A\xE8\x00\x00\x00\x00\x80\xB8\x00\x00\x00\x00\x00\x75\x4C\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xA7\x33\xF6\x48\x89\x75\xAF\x89\x75\xB7\x0F\x10\x45\xA7\x0F\x11\x43\x58\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4B\x00\xE8\x00\x00\x00\x00\x4C\x8B\x00\x48\x8D\x15\x00\x00\x00\x00\x48\x8B\xC8\x41\xFF\x90\x00\x00\x00\x00\x45\x88\x75\x14\x48\x89\x75\xAF\xE9\x00\x00\x00\x00\x48\x8B\x7B\x40\x8B\x43\x78\x83\xF8\x06\x7F\x4B\x48\x8B\xCF\xE8\x00\x00\x00\x00\x8B\xD0\x48\x8B\xCB\xE8\x00\x00\x00\x00\x48\x8B\xCF\xE8\x00\x00\x00\x00\x8B\xD0\x48\x8B\xCB\xE8\x00\x00\x00\x00\x8B\x43\x78\x83\xF8\x06\x75\x1F\x44\x39\x73\x7C\x75\x19\x45\x8B\xC6\x8B\xD0\x48\x8B\xCB\xE8\x00\x00\x00\x00\x84\xC0\x75\x08\x48\x8B\xCB\xE8\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x45\xA7\x33\xF6\x48\x89\x75\xAF\x89\x75\xB7\x0F\x10\x45\xA7\x0F\x11\x43\x58\xF2\x0F\x10\x4D\x00\xF2\x0F\x11\x4B\x00\x45\x88\x75\x14\x48\x89\x75\xAF\xE9\x00\x00\x00\x00", "xxxxxxxxxxxxxxxx?xxx????xxx?????xxxx????xxxxxxxxxxxxxx????xxxxx????xxxxx????xxxxxxxxx????xx????xxxxx????xx?????xxxxxxxxxxxxxxxxx????xxxxxxxx????xxxxxxxx????xxx????xxxxxxxxxxxxxxxxxxxxxxxxx?xxxx?xxx??xxxxx????xxx????xxxxxx????xxxxxxxxxxx????x????xxxxx????xx????x????xxxxxxxx????xxxxxxxxx????xxxxxxxxx????xxxx????xxxxx????xxxxxxxxxxx????xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx????xxxxxxxxxx????xxxxxxxxxxxxxxxxxxxxxxx?xxxx?xxx??xxx?????x????xxxx????xxx??xxx?????x????x????xx????xx????xxxxxx????xxxxx????xx?????xxxxx????xxxxxxxxxxxxxxxxxxxxxxxxx?xxxx?x????xxxxxx????xxxxxx????xxxxxxxxx????xxxxxxxxxxxxxxxx????xxxxxx????xxxx????xxxxxx????xxxxxxxxxxxxxxxxxxxxxxx????xxxxxxxx????xxx????xxxxxxxxxxxxxxxxxxxxxxxxx?xxxx?xxxxxxxxx????");